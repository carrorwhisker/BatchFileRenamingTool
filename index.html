<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡å¤åˆ¶é‡å‘½åæ–‡ä»¶ç”Ÿæˆå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #555;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #667eea;
            margin-right: 10px;
            border-radius: 2px;
        }

        table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .column-name-input {
            width: 100% !important;
            background: transparent !important;
            border: none !important;
            color: white !important;
            font-weight: bold !important;
            text-align: center !important;
            padding: 5px !important;
        }

        .column-name-input:focus {
            background: rgba(255, 255, 255, 0.2) !important;
            outline: 2px solid rgba(255, 255, 255, 0.5) !important;
            border-radius: 3px !important;
        }

        th .btn-small {
            flex-shrink: 0;
            min-width: 20px;
            height: 20px;
            padding: 0;
            line-height: 1;
            font-size: 16px;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background: #f9f9f9;
        }

        input[type="text"], input[type="file"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            margin: 5px;
        }

        button:hover {
            background: #5568d3;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        button.success {
            background: #27ae60;
        }

        button.success:hover {
            background: #229954;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .template-editor {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .template-editor input {
            flex: 1;
        }

        .variable-config {
            margin-top: 15px;
        }

        .variable-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .variable-item input {
            flex: 1;
        }

        .variable-item select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .preview-section {
            max-height: 400px;
            overflow-y: auto;
        }

        .preview-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            word-break: break-all;
        }

        .preview-item .old-name {
            color: #999;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .preview-item .new-name {
            color: #333;
            font-weight: bold;
        }

        .file-list {
            margin-top: 15px;
        }

        .file-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item .file-name {
            flex: 1;
            word-break: break-all;
        }

        .actions {
            text-align: center;
            margin-top: 30px;
        }

        .actions button {
            padding: 15px 40px;
            font-size: 16px;
        }

        .help-text {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .lang-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .lang-switcher button {
            padding: 8px 16px;
            font-size: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .lang-switcher button:hover {
            background: #5568d3;
        }

        .container {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="lang-switcher">
            <button onclick="toggleLanguage()" id="langBtn">EN</button>
        </div>
        <h1 id="title">ğŸ“ æ‰¹é‡æ–‡ä»¶ç”Ÿæˆå·¥å…·</h1>

        <!-- æ¨¡æ¿æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
        <div class="section">
            <div class="section-title" data-i18n="selectTemplate">é€‰æ‹©æ¨¡æ¿æ–‡ä»¶</div>
            <label for="templateFileInput" style="display: block; margin-bottom: 10px;">
                <span id="fileInputLabel" data-i18n="chooseFile">é€‰æ‹©æ–‡ä»¶</span>
                <input type="file" id="templateFileInput" style="display: none;" onchange="handleTemplateFileSelect(event)">
                <button type="button" onclick="document.getElementById('templateFileInput').click()" class="btn-small" style="margin-left: 10px;" data-i18n="browseFile">æµè§ˆ</button>
            </label>
            <div class="file-list" id="templateFileInfo">
                <div class="help-text" id="noFileSelected" data-i18n="noFileSelected">æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶</div>
            </div>
            <div class="help-text" data-i18n="templateHelp">
                é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ä½œä¸ºæ¨¡æ¿ï¼Œå°†æ ¹æ®æ•°æ®ç”Ÿæˆå¤šä¸ªä¸åŒåç§°çš„æ–‡ä»¶å‰¯æœ¬
            </div>
        </div>

        <!-- æ•°æ®ç®¡ç†åŒºåŸŸ -->
        <div class="section">
            <div class="section-title" data-i18n="dataManagement">æ•°æ®ç®¡ç†</div>
            <div style="overflow-x: auto; max-width: 100%;">
                <table id="dataTable">
                    <thead id="dataTableHead">
                        <!-- è¡¨å¤´å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- æ•°æ®è¡Œå°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 10px;">
                <button onclick="addDataRow()" class="btn-small" data-i18n="addRow">+ æ·»åŠ æ•°æ®è¡Œ</button>
                <button onclick="addDataColumn()" class="btn-small" data-i18n="addColumn">+ æ·»åŠ åˆ—</button>
            </div>
        </div>

        <!-- æ–‡ä»¶åæ¨¡æ¿é…ç½® -->
        <div class="section">
            <div class="section-title" data-i18n="templateConfig">æ–‡ä»¶åæ¨¡æ¿é…ç½®</div>
            <div class="template-editor">
                <input type="text" id="templateInput" data-i18n-placeholder="templatePlaceholder" 
                       oninput="updateVariableConfig()">
            </div>
            <div class="help-text" data-i18n="templateHelpText">
                ä½¿ç”¨ {å˜é‡å} æ¥å®šä¹‰å˜é‡ï¼Œå˜é‡åå¯¹åº”æ•°æ®ç®¡ç†çš„åˆ—åã€‚å°†æ ¹æ®æ•°æ®è¡Œæ•°é‡ç”Ÿæˆå¯¹åº”æ•°é‡çš„æ–‡ä»¶ã€‚
            </div>
            
            <div class="variable-config" id="variableConfig">
                <!-- å˜é‡é…ç½®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div class="section">
            <div class="section-title" data-i18n="preview">ç”Ÿæˆæ–‡ä»¶é¢„è§ˆ</div>
            <div class="preview-section" id="previewSection"></div>
            <button onclick="generatePreview()" class="btn-small" data-i18n="refreshPreview">åˆ·æ–°é¢„è§ˆ</button>
            <div class="help-text" id="fileCountText">
                <span id="fileCountDisplay"></span>
                <span id="fileCount" style="display: none;">0</span>
            </div>
        </div>

        <!-- çŠ¶æ€æç¤º -->
        <div class="status" id="statusMessage"></div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="actions">
            <button onclick="generateFiles()" class="success" data-i18n="generateFiles">ç”Ÿæˆæ–‡ä»¶</button>
        </div>
    </div>

    <script>
        // è¯­è¨€è®¾ç½®
        let currentLang = 'zh';
        const translations = {
            zh: {
                title: 'ğŸ“ æ‰¹é‡æ–‡ä»¶ç”Ÿæˆå·¥å…·',
                selectTemplate: 'é€‰æ‹©æ¨¡æ¿æ–‡ä»¶',
                templateHelp: 'é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ä½œä¸ºæ¨¡æ¿ï¼Œå°†æ ¹æ®æ•°æ®ç”Ÿæˆå¤šä¸ªä¸åŒåç§°çš„æ–‡ä»¶å‰¯æœ¬',
                dataManagement: 'æ•°æ®ç®¡ç†',
                addRow: '+ æ·»åŠ æ•°æ®è¡Œ',
                addColumn: '+ æ·»åŠ åˆ—',
                templateConfig: 'æ–‡ä»¶åæ¨¡æ¿é…ç½®',
                templatePlaceholder: 'ä¾‹å¦‚ï¼šç¤ºä¾‹æ–‡æ¡£_{ç¼–å·}_{æ—¥æœŸ}_{é¡¹ç›®åç§°}.xls',
                templateHelpText: 'ä½¿ç”¨ {å˜é‡å} æ¥å®šä¹‰å˜é‡ï¼Œå˜é‡åå¯¹åº”æ•°æ®ç®¡ç†çš„åˆ—åã€‚å°†æ ¹æ®æ•°æ®è¡Œæ•°é‡ç”Ÿæˆå¯¹åº”æ•°é‡çš„æ–‡ä»¶ã€‚',
                preview: 'ç”Ÿæˆæ–‡ä»¶é¢„è§ˆ',
                refreshPreview: 'åˆ·æ–°é¢„è§ˆ',
                fileCount: 'å°†ç”Ÿæˆ {count} ä¸ªæ–‡ä»¶ï¼ˆæ ¹æ®æ•°æ®è¡Œæ•°é‡ï¼‰',
                generateFiles: 'ç”Ÿæˆæ–‡ä»¶',
                operation: 'æ“ä½œ',
                delete: 'åˆ é™¤',
                clear: 'æ¸…é™¤',
                selectColumn: '-- é€‰æ‹©æ•°æ®åˆ— --',
                noVariables: 'æœªæ£€æµ‹åˆ°å˜é‡ï¼Œè¯·ä½¿ç”¨ {å˜é‡å} æ ¼å¼ï¼Œå˜é‡åå¯¹åº”æ•°æ®ç®¡ç†çš„åˆ—å',
                selectTemplateFirst: 'è¯·å…ˆé€‰æ‹©æ¨¡æ¿æ–‡ä»¶',
                addRowFirst: 'è¯·å…ˆæ·»åŠ æ•°æ®è¡Œ',
                chooseFile: 'é€‰æ‹©æ–‡ä»¶',
                browseFile: 'æµè§ˆ',
                noFileSelected: 'æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶',
                selectColumnForVars: 'è¯·ä¸ºä»¥ä¸‹å˜é‡é€‰æ‹©æ•°æ®åˆ—: {vars}',
                generating: 'æ­£åœ¨ç”Ÿæˆæ–‡ä»¶ï¼Œè¯·ç¨å€™...',
                generateComplete: 'æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼æˆåŠŸ: {success}, å¤±è´¥: {error}',
                templateFile: 'æ¨¡æ¿æ–‡ä»¶: {name} ({size} KB)',
                generateFile: 'ç”Ÿæˆæ–‡ä»¶ {index}: {name}',
                atLeastOneColumn: 'è‡³å°‘éœ€è¦ä¿ç•™ä¸€åˆ—',
                column: 'åˆ—',
                exampleDoc: 'ç¤ºä¾‹æ–‡æ¡£'
            },
            en: {
                title: 'ğŸ“ Batch File Generator',
                selectTemplate: 'Select Template File',
                templateHelp: 'Select a file as template, multiple file copies with different names will be generated based on data',
                dataManagement: 'Data Management',
                addRow: '+ Add Data Row',
                addColumn: '+ Add Column',
                templateConfig: 'Filename Template Configuration',
                templatePlaceholder: 'e.g.: Example_Document_{Code}_{Date}_{ProjectName}.xls',
                templateHelpText: 'Use {variableName} to define variables, variable names correspond to column names in data management. Files will be generated based on the number of data rows.',
                preview: 'File Generation Preview',
                refreshPreview: 'Refresh Preview',
                fileCount: 'Will generate {count} files (based on number of data rows)',
                generateFiles: 'Generate Files',
                operation: 'Operation',
                delete: 'Delete',
                clear: 'Clear',
                selectColumn: '-- Select Data Column --',
                noVariables: 'No variables detected, please use {variableName} format, variable names correspond to column names in data management',
                selectTemplateFirst: 'Please select template file first',
                addRowFirst: 'Please add data rows first',
                chooseFile: 'Choose File',
                browseFile: 'Browse',
                noFileSelected: 'No file selected',
                selectColumnForVars: 'Please select data columns for the following variables: {vars}',
                generating: 'Generating files, please wait...',
                generateComplete: 'File generation complete! Success: {success}, Failed: {error}',
                templateFile: 'Template File: {name} ({size} KB)',
                generateFile: 'Generated File {index}: {name}',
                atLeastOneColumn: 'At least one column must be kept',
                column: 'Column',
                exampleDoc: 'Example Document'
            }
        };

        // é»˜è®¤æ•°æ®
        const defaultData = {
            zh: [['ç¤ºä¾‹é¡¹ç›®A', 'A001', '20250101']],
            en: [['Example Project A', 'A001', '20250101']]
        };

        const defaultColumnNames = {
            zh: ['é¡¹ç›®åç§°', 'ç¼–å·', 'æ—¥æœŸ'],
            en: ['Project Name', 'Code', 'Date']
        };

        let columnNames = defaultColumnNames[currentLang];
        let dataRows = [];
        let templateFile = null;
        let variables = [];
        let variableMappings = {};

        // åˆ‡æ¢è¯­è¨€
        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            updateLanguage();
        }

        // æ›´æ–°è¯­è¨€
        function updateLanguage() {
            const t = translations[currentLang];
            document.getElementById('langBtn').textContent = currentLang === 'zh' ? 'EN' : 'ä¸­æ–‡';
            document.getElementById('title').textContent = t['title'];
            
            // æ›´æ–°æ‰€æœ‰å¸¦ data-i18n å±æ€§çš„å…ƒç´ 
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });
            
            // æ›´æ–°æ–‡ä»¶æ•°é‡æ˜¾ç¤º
            updateFileCountText();

            // æ›´æ–° placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) {
                    el.placeholder = t[key];
                }
            });

            // ä¿å­˜å½“å‰æ•°æ®
            const currentRows = [];
            const rows = document.querySelectorAll('#dataTableBody tr');
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input.data-cell');
                const rowData = Array.from(inputs).map(input => input.value);
                currentRows.push(rowData);
            });
            
            // æ£€æŸ¥åˆ—åæ˜¯å¦æ˜¯é»˜è®¤åˆ—åï¼Œå¦‚æœæ˜¯åˆ™æ›´æ–°ä¸ºå¯¹åº”è¯­è¨€çš„é»˜è®¤åˆ—å
            const isDefaultColumnsZh = JSON.stringify(columnNames) === JSON.stringify(defaultColumnNames['zh']);
            const isDefaultColumnsEn = JSON.stringify(columnNames) === JSON.stringify(defaultColumnNames['en']);
            
            if (isDefaultColumnsZh || isDefaultColumnsEn) {
                // å¦‚æœä½¿ç”¨çš„æ˜¯é»˜è®¤åˆ—åï¼Œåˆ™æ›´æ–°ä¸ºå½“å‰è¯­è¨€çš„é»˜è®¤åˆ—å
                columnNames = [...defaultColumnNames[currentLang]];
            }
            
            // æ£€æŸ¥æ•°æ®æ˜¯å¦æ˜¯é»˜è®¤æ•°æ®
            const isDefaultDataZh = currentRows.length === 1 && 
                                   JSON.stringify(currentRows[0]) === JSON.stringify(defaultData['zh'][0]);
            const isDefaultDataEn = currentRows.length === 1 && 
                                   JSON.stringify(currentRows[0]) === JSON.stringify(defaultData['en'][0]);
            
            if (isDefaultDataZh || isDefaultDataEn || currentRows.length === 0) {
                // å¦‚æœæ˜¯é»˜è®¤æ•°æ®æˆ–ç©ºæ•°æ®ï¼Œåˆ™åŠ è½½å½“å‰è¯­è¨€çš„é»˜è®¤æ•°æ®
                const tbody = document.getElementById('dataTableBody');
                tbody.innerHTML = '';
                defaultData[currentLang].forEach(row => {
                    addDataRow(row);
                });
            } else {
                // ä¿ç•™ç°æœ‰æ•°æ®ï¼Œåªæ›´æ–°è¡¨å¤´
                renderTableHeader();
                // é‡æ–°å¡«å……æ•°æ®
                const tbody = document.getElementById('dataTableBody');
                tbody.innerHTML = '';
                currentRows.forEach(rowData => {
                    addDataRow(rowData);
                });
            }
            
            // æ›´æ–°æ¨¡æ¿ï¼ˆå¦‚æœæ¨¡æ¿æ˜¯é»˜è®¤ç”Ÿæˆçš„ï¼‰
            const templateInput = document.getElementById('templateInput');
            const defaultTemplateZh = generateDefaultTemplateForLang('zh');
            const defaultTemplateEn = generateDefaultTemplateForLang('en');
            if (templateInput.value === defaultTemplateZh || templateInput.value === defaultTemplateEn) {
                templateInput.value = generateDefaultTemplate();
            }
            
            // æ›´æ–°æ¨¡æ¿æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
            if (templateFile) {
                displayTemplateFileInfo();
            }
            
            updateVariableConfig();
            generatePreview();
        }

        // ä¸ºæŒ‡å®šè¯­è¨€ç”Ÿæˆé»˜è®¤æ¨¡æ¿
        function generateDefaultTemplateForLang(lang) {
            const cols = defaultColumnNames[lang];
            if (cols.length === 0) return '';
            const t = translations[lang];
            const templateParts = [t.exampleDoc];
            cols.forEach(colName => {
                templateParts.push(`{${colName}}`);
            });
            return templateParts.join('_') + '.xls';
        }

        // è·å–ç¿»è¯‘æ–‡æœ¬
        function t(key, params = {}) {
            let text = translations[currentLang][key] || key;
            Object.keys(params).forEach(k => {
                text = text.replace(`{${k}}`, params[k]);
            });
            return text;
        }

        // ç”Ÿæˆé»˜è®¤æ¨¡æ¿
        function generateDefaultTemplate() {
            if (columnNames.length === 0) return '';
            
            const t = translations[currentLang];
            const templateParts = [t.exampleDoc];
            columnNames.forEach(colName => {
                templateParts.push(`{${colName}}`);
            });
            return templateParts.join('_') + '.xls';
        }

        // åˆå§‹åŒ–
        function init() {
            // åˆå§‹åŒ–è¡¨å¤´
            renderTableHeader();
            
            // ç”Ÿæˆå¹¶è®¾ç½®é»˜è®¤æ¨¡æ¿
            const defaultTemplate = generateDefaultTemplate();
            if (defaultTemplate) {
                document.getElementById('templateInput').value = defaultTemplate;
            }
            
            // åŠ è½½é»˜è®¤æ•°æ®
            defaultData[currentLang].forEach(row => {
                addDataRow(row);
            });
            
            // æ›´æ–°å˜é‡é…ç½®
            updateVariableConfig();
            
            // åˆå§‹åŒ–æ–‡ä»¶é€‰æ‹©æç¤º
            displayTemplateFileInfo();
            
            // åˆå§‹åŒ–è¯­è¨€
            updateLanguage();
        }

        // æ¸²æŸ“è¡¨å¤´
        function renderTableHeader() {
            const thead = document.getElementById('dataTableHead');
            let headerHTML = '<tr>';
            
            columnNames.forEach((colName, index) => {
                const deleteColumnText = t('delete') + ' ' + t('column');
                headerHTML += `
                    <th>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="text" class="column-name-input" value="${colName}" 
                                   onchange="updateColumnName(${index}, this.value)">
                            <button onclick="removeDataColumn(${index})" class="btn-small danger" 
                                    style="padding: 2px 5px; font-size: 10px;" title="${deleteColumnText}">Ã—</button>
                        </div>
                    </th>
                `;
            });
            
            headerHTML += `<th>${t('operation')}</th></tr>`;
            thead.innerHTML = headerHTML;
            
            // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ•°æ®è¡Œä»¥åŒ¹é…åˆ—æ•°
            renderDataRows();
            updateVariableConfig();
        }

        // æ›´æ–°åˆ—å
        function updateColumnName(index, newName) {
            columnNames[index] = newName;
            // å¦‚æœæ¨¡æ¿ä¸ºç©ºï¼Œè‡ªåŠ¨ç”Ÿæˆ
            const templateInput = document.getElementById('templateInput');
            if (!templateInput.value.trim()) {
                templateInput.value = generateDefaultTemplate();
            }
            updateVariableConfig();
        }

        // æ·»åŠ åˆ—
        function addDataColumn() {
            const t = translations[currentLang];
            const newColumnName = `${t.column}${columnNames.length + 1}`;
            columnNames.push(newColumnName);
            renderTableHeader();
            // å¦‚æœæ¨¡æ¿ä¸ºç©ºï¼Œè‡ªåŠ¨ç”Ÿæˆ
            const templateInput = document.getElementById('templateInput');
            if (!templateInput.value.trim()) {
                templateInput.value = generateDefaultTemplate();
            }
            updateDataRows();
        }

        // åˆ é™¤åˆ—
        function removeDataColumn(index) {
            if (columnNames.length <= 1) {
                showStatus(t('atLeastOneColumn'), 'error');
                return;
            }
            
            columnNames.splice(index, 1);
            renderTableHeader();
            updateDataRows();
        }

        // æ¸²æŸ“æ•°æ®è¡Œ
        function renderDataRows() {
            const tbody = document.getElementById('dataTableBody');
            const currentRows = Array.from(tbody.querySelectorAll('tr'));
            
            currentRows.forEach((row, rowIndex) => {
                const inputs = Array.from(row.querySelectorAll('input.data-cell'));
                const rowData = inputs.map(input => input.value);
                
                let rowHTML = '';
                columnNames.forEach((colName, colIndex) => {
                    const value = rowData[colIndex] || '';
                    rowHTML += `<td><input type="text" class="data-cell" value="${value}"></td>`;
                });
                rowHTML += `<td><button onclick="removeDataRow(this)" class="btn-small danger">${t('delete')}</button></td>`;
                row.innerHTML = rowHTML;
            });
        }

        // æ·»åŠ æ•°æ®è¡Œ
        function addDataRow(rowData = []) {
            const tbody = document.getElementById('dataTableBody');
            const row = document.createElement('tr');
            
            columnNames.forEach((colName, index) => {
                const value = rowData[index] || '';
                row.innerHTML += `<td><input type="text" class="data-cell" value="${value}"></td>`;
            });
            
            row.innerHTML += `<td><button onclick="removeDataRow(this)" class="btn-small danger">${t('delete')}</button></td>`;
            tbody.appendChild(row);
            updateDataRows();
        }

        // åˆ é™¤æ•°æ®è¡Œ
        function removeDataRow(btn) {
            btn.closest('tr').remove();
            updateDataRows();
        }

        // æ›´æ–°æ•°æ®è¡Œæ•°ç»„
        function updateDataRows() {
            dataRows = [];
            const rows = document.querySelectorAll('#dataTableBody tr');
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input.data-cell');
                const rowData = {};
                columnNames.forEach((colName, index) => {
                    if (inputs[index]) {
                        rowData[colName] = inputs[index].value;
                    }
                });
                dataRows.push(rowData);
            });
            generatePreview();
        }

        // æ›´æ–°å˜é‡é…ç½®ï¼ˆæ ¹æ®åˆ—åè‡ªåŠ¨ç”Ÿæˆï¼‰
        function updateVariableConfig() {
            const template = document.getElementById('templateInput').value;
            const variableRegex = /\{([^}]+)\}/g;
            const matches = [...template.matchAll(variableRegex)];
            
            variables = matches.map(match => match[1]);
            variables = [...new Set(variables)]; // å»é‡
            
            // ç”Ÿæˆå˜é‡é…ç½®UI
            const configDiv = document.getElementById('variableConfig');
            configDiv.innerHTML = '';
            
            if (variables.length === 0) {
                configDiv.innerHTML = `<div class="help-text">${t('noVariables')}</div>`;
                return;
            }
            
            // ä¸ºæ¯ä¸ªå˜é‡åˆ›å»ºé…ç½®é¡¹
            variables.forEach(variable => {
                const item = document.createElement('div');
                item.className = 'variable-item';
                
                // æ£€æŸ¥å˜é‡æ˜¯å¦åŒ¹é…æŸä¸ªåˆ—å
                const matchedColumn = columnNames.find(col => col === variable);
                const currentMapping = variableMappings[variable] || (matchedColumn ? variable : '');
                
                let optionsHTML = `<option value="">${t('selectColumn')}</option>`;
                columnNames.forEach(colName => {
                    const selected = currentMapping === colName ? 'selected' : '';
                    optionsHTML += `<option value="${colName}" ${selected}>${colName}</option>`;
                });
                
                item.innerHTML = `
                    <label style="min-width: 100px;">${variable}:</label>
                    <select onchange="updateVariableMapping('${variable}', this.value)">
                        ${optionsHTML}
                    </select>
                `;
                configDiv.appendChild(item);
                
                // å¦‚æœå˜é‡ååŒ¹é…åˆ—åï¼Œè‡ªåŠ¨è®¾ç½®æ˜ å°„
                if (matchedColumn && !variableMappings[variable]) {
                    variableMappings[variable] = matchedColumn;
                    item.querySelector('select').value = matchedColumn;
                }
            });
            
            generatePreview();
        }

        // æ›´æ–°å˜é‡æ˜ å°„
        function updateVariableMapping(variable, column) {
            variableMappings[variable] = column;
            generatePreview();
        }

        // å¤„ç†æ¨¡æ¿æ–‡ä»¶é€‰æ‹©
        function handleTemplateFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                templateFile = files[0];
                displayTemplateFileInfo();
                generatePreview();
            }
        }

        // æ˜¾ç¤ºæ¨¡æ¿æ–‡ä»¶ä¿¡æ¯
        function displayTemplateFileInfo() {
            const fileInfoDiv = document.getElementById('templateFileInfo');
            const noFileDiv = document.getElementById('noFileSelected');
            if (templateFile) {
                if (noFileDiv) noFileDiv.style.display = 'none';
                fileInfoDiv.innerHTML = `
                    <div class="file-item">
                        <span class="file-name">${t('templateFile', {name: templateFile.name, size: (templateFile.size / 1024).toFixed(2)})}</span>
                        <button onclick="clearTemplateFile()" class="btn-small danger">${t('clear')}</button>
                    </div>
                `;
            } else {
                if (noFileDiv) noFileDiv.style.display = 'block';
                const existingFileItem = fileInfoDiv.querySelector('.file-item');
                if (existingFileItem) {
                    existingFileItem.remove();
                }
            }
        }

        // æ¸…é™¤æ¨¡æ¿æ–‡ä»¶
        function clearTemplateFile() {
            templateFile = null;
            document.getElementById('templateFileInput').value = '';
            displayTemplateFileInfo();
            generatePreview();
        }

        // ç”Ÿæˆé¢„è§ˆ
        function generatePreview() {
            const previewDiv = document.getElementById('previewSection');
            previewDiv.innerHTML = '';
            
            const fileCountEl = document.getElementById('fileCount');
            if (!templateFile) {
                previewDiv.innerHTML = `<div class="help-text">${t('selectTemplateFirst')}</div>`;
                if (fileCountEl) fileCountEl.textContent = '0';
                updateFileCountText();
                return;
            }
            
            if (dataRows.length === 0) {
                previewDiv.innerHTML = `<div class="help-text">${t('addRowFirst')}</div>`;
                if (fileCountEl) fileCountEl.textContent = '0';
                updateFileCountText();
                return;
            }
            
            // æ£€æŸ¥å˜é‡æ˜ å°„æ˜¯å¦å®Œæ•´
            const unmappedVars = variables.filter(v => !variableMappings[v]);
            if (unmappedVars.length > 0) {
                previewDiv.innerHTML = `<div class="help-text" style="color: #e74c3c;">${t('selectColumnForVars', {vars: unmappedVars.join(', ')})}</div>`;
                if (fileCountEl) fileCountEl.textContent = '0';
                updateFileCountText();
                return;
            }
            
            // ç”Ÿæˆé¢„è§ˆ
            const template = document.getElementById('templateInput').value;
            const originalExt = templateFile.name.substring(templateFile.name.lastIndexOf('.'));
            
            dataRows.forEach((data, index) => {
                let newName = template;
                variables.forEach(variable => {
                    const column = variableMappings[variable];
                    const value = column && data[column] ? data[column] : '';
                    newName = newName.replace(new RegExp(`\\{${variable}\\}`, 'g'), value);
                });
                
                // ç¡®ä¿æœ‰æ‰©å±•å
                if (!newName.includes('.')) {
                    newName += originalExt;
                }
                
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `
                    <div class="old-name">${t('templateFile', {name: templateFile.name, size: (templateFile.size / 1024).toFixed(2)})}</div>
                    <div class="new-name">${t('generateFile', {index: index + 1, name: newName})}</div>
                `;
                previewDiv.appendChild(previewItem);
            });
            
            if (fileCountEl) fileCountEl.textContent = dataRows.length;
            updateFileCountText();
        }

        // æ›´æ–°æ–‡ä»¶æ•°é‡æ–‡æœ¬
        function updateFileCountText() {
            const countEl = document.getElementById('fileCount');
            const count = countEl ? countEl.textContent : '0';
            const fileCountDisplay = document.getElementById('fileCountDisplay');
            if (fileCountDisplay) {
                fileCountDisplay.innerHTML = t('fileCount', {count: count});
            }
        }

        // ç”Ÿæˆæ–‡ä»¶
        async function generateFiles() {
            if (!templateFile) {
                showStatus(t('selectTemplateFirst'), 'error');
                return;
            }
            
            if (dataRows.length === 0) {
                showStatus(t('addRowFirst'), 'error');
                return;
            }
            
            const unmappedVars = variables.filter(v => !variableMappings[v]);
            if (unmappedVars.length > 0) {
                showStatus(t('selectColumnForVars', {vars: unmappedVars.join(', ')}), 'error');
                return;
            }
            
            const template = document.getElementById('templateInput').value;
            const originalExt = templateFile.name.substring(templateFile.name.lastIndexOf('.'));
            
            // è¯»å–æ¨¡æ¿æ–‡ä»¶å†…å®¹
            const templateFileBuffer = await templateFile.arrayBuffer();
            let successCount = 0;
            let errorCount = 0;
            
            showStatus(t('generating'), 'success');
            
            // å»¶è¿Ÿä¸‹è½½ï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢å¤šä¸ªä¸‹è½½
            for (let i = 0; i < dataRows.length; i++) {
                try {
                    const data = dataRows[i];
                    
                    let newName = template;
                    variables.forEach(variable => {
                        const column = variableMappings[variable];
                        const value = column && data[column] ? data[column] : '';
                        newName = newName.replace(new RegExp(`\\{${variable}\\}`, 'g'), value);
                    });
                    
                    // ç¡®ä¿æœ‰æ‰©å±•å
                    if (!newName.includes('.')) {
                        newName += originalExt;
                    }
                    
                    // åˆ›å»ºæ–°æ–‡ä»¶å¹¶ä¸‹è½½
                    const newBlob = new Blob([templateFileBuffer], { type: templateFile.type });
                    const url = URL.createObjectURL(newBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = newName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    successCount++;
                    
                    // å»¶è¿Ÿä¸‹è½½ï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢
                    if (i < dataRows.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                } catch (error) {
                    console.error('ç”Ÿæˆæ–‡ä»¶å¤±è´¥:', error);
                    errorCount++;
                }
            }
            
            showStatus(t('generateComplete', {success: successCount, error: errorCount}), 'success');
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // ç›‘å¬æ•°æ®è¾“å…¥å˜åŒ–
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('data-cell')) {
                updateDataRows();
            } else if (e.target.classList.contains('column-name-input')) {
                // åˆ—åå˜åŒ–æ—¶ï¼Œæ›´æ–°å˜é‡é…ç½®
                updateVariableConfig();
            }
        });

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
