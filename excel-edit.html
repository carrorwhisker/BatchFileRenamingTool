<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡ä¿®æ”¹Excelå•å…ƒæ ¼å†…å®¹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #555;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #667eea;
            margin-right: 10px;
            border-radius: 2px;
        }

        table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .column-name-input {
            width: 100% !important;
            background: transparent !important;
            border: none !important;
            color: white !important;
            font-weight: bold !important;
            text-align: center !important;
            padding: 5px !important;
        }

        .column-name-input:focus {
            background: rgba(255, 255, 255, 0.2) !important;
            outline: 2px solid rgba(255, 255, 255, 0.5) !important;
            border-radius: 3px !important;
        }

        th .btn-small {
            flex-shrink: 0;
            min-width: 20px;
            height: 20px;
            padding: 0;
            line-height: 1;
            font-size: 16px;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background: #f9f9f9;
        }

        input[type="text"], input[type="file"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            margin: 5px;
        }

        button:hover {
            background: #5568d3;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        button.success {
            background: #27ae60;
        }

        button.success:hover {
            background: #229954;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .file-list {
            margin-top: 15px;
        }

        .file-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item .file-name {
            flex: 1;
            word-break: break-all;
        }

        .actions {
            text-align: center;
            margin-top: 30px;
        }

        .actions button {
            padding: 15px 40px;
            font-size: 16px;
        }

        .help-text {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .cell-input {
            width: 100px;
            text-transform: uppercase;
        }

        .content-input {
            width: 100%;
        }

        .file-select-cell {
            width: 200px;
        }

        .file-select-cell select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š æ‰¹é‡ä¿®æ”¹Excelå•å…ƒæ ¼å†…å®¹</h1>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="section">
            <div class="section-title">ä¸Šä¼ Excelæ–‡ä»¶</div>
            <input type="file" id="fileInput" multiple accept=".xlsx,.xls">
            <div class="file-list" id="fileList"></div>
            <div class="help-text">
                å¯ä»¥ä¸Šä¼ å¤šä¸ªExcelæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶å°†æ ¹æ®é…ç½®è¿›è¡Œä¿®æ”¹
            </div>
        </div>

        <!-- å•å…ƒæ ¼ä¿®æ”¹é…ç½® -->
        <div class="section">
            <div class="section-title">å•å…ƒæ ¼ä¿®æ”¹é…ç½®</div>
            <div style="overflow-x: auto; max-width: 100%;">
                <table id="configTable">
                    <thead id="configTableHead">
                        <!-- è¡¨å¤´å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </thead>
                    <tbody id="configTableBody">
                        <!-- æ•°æ®è¡Œå°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 10px;">
                <button onclick="addConfigRow()" class="btn-small">+ æ·»åŠ é…ç½®è¡Œ</button>
                <button onclick="addConfigColumn()" class="btn-small">+ æ·»åŠ åˆ—</button>
            </div>
            <div class="help-text">
                æ¯è¡Œä»£è¡¨ä¸€ä¸ªå•å…ƒæ ¼ä¿®æ”¹é…ç½®ã€‚åˆ—åå¯ä»¥è‡ªå®šä¹‰ï¼Œä¾‹å¦‚ï¼šæ–‡ä»¶ã€å•å…ƒæ ¼åæ ‡ã€æ–°å†…å®¹ç­‰
            </div>
        </div>

        <!-- çŠ¶æ€æç¤º -->
        <div class="status" id="statusMessage"></div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="actions">
            <button onclick="processFiles()" class="success">å¼€å§‹å¤„ç†</button>
        </div>
    </div>

    <script>
        let uploadedFiles = [];
        let columnNames = ['æ–‡ä»¶', 'å•å…ƒæ ¼åæ ‡', 'æ–°å†…å®¹']; // é»˜è®¤åˆ—å
        let configRows = [];

        // åˆå§‹åŒ–
        function init() {
            renderTableHeader();
            addConfigRow(['', 'J5', '']); // é»˜è®¤æ·»åŠ ä¸€è¡Œï¼Œå•å…ƒæ ¼ä¸ºJ5
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            uploadedFiles = files;
            displayFileList();
            updateFileSelects();
        }

        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
        function displayFileList() {
            const fileListDiv = document.getElementById('fileList');
            fileListDiv.innerHTML = '';
            
            if (uploadedFiles.length === 0) {
                fileListDiv.innerHTML = '<div class="help-text">æœªä¸Šä¼ æ–‡ä»¶</div>';
                return;
            }

            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span class="file-name">${index + 1}. ${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
                `;
                fileListDiv.appendChild(fileItem);
            });
        }

        // æ¸²æŸ“è¡¨å¤´
        function renderTableHeader() {
            const thead = document.getElementById('configTableHead');
            let headerHTML = '<tr>';
            
            columnNames.forEach((colName, index) => {
                headerHTML += `
                    <th>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="text" class="column-name-input" value="${colName}" 
                                   onchange="updateColumnName(${index}, this.value)">
                            <button onclick="removeConfigColumn(${index})" class="btn-small danger" 
                                    style="padding: 2px 5px; font-size: 10px;" title="åˆ é™¤åˆ—">Ã—</button>
                        </div>
                    </th>
                `;
            });
            
            headerHTML += '<th>æ“ä½œ</th></tr>';
            thead.innerHTML = headerHTML;
            
            renderConfigRows();
        }

        // æ›´æ–°åˆ—å
        function updateColumnName(index, newName) {
            columnNames[index] = newName;
            renderTableHeader();
        }

        // æ·»åŠ åˆ—
        function addConfigColumn() {
            const newColumnName = `åˆ—${columnNames.length + 1}`;
            columnNames.push(newColumnName);
            renderTableHeader();
        }

        // åˆ é™¤åˆ—
        function removeConfigColumn(index) {
            if (columnNames.length <= 1) {
                showStatus('è‡³å°‘éœ€è¦ä¿ç•™ä¸€åˆ—', 'error');
                return;
            }
            
            columnNames.splice(index, 1);
            renderTableHeader();
        }

        // æ¸²æŸ“é…ç½®è¡Œ
        function renderConfigRows() {
            const tbody = document.getElementById('configTableBody');
            tbody.innerHTML = '';
            
            configRows.forEach((rowData, rowIndex) => {
                const row = document.createElement('tr');
                let rowHTML = '';
                
                columnNames.forEach((colName, colIndex) => {
                    const value = rowData[colIndex] || '';
                    
                    // æ ¹æ®åˆ—ååˆ¤æ–­è¾“å…¥ç±»å‹
                    if (colName === 'æ–‡ä»¶' || colName.toLowerCase().includes('æ–‡ä»¶')) {
                        rowHTML += `
                            <td class="file-select-cell">
                                <select class="config-cell" data-row="${rowIndex}" data-col="${colIndex}">
                                    <option value="">-- é€‰æ‹©æ–‡ä»¶ --</option>
                                    ${uploadedFiles.map((file, idx) => 
                                        `<option value="${idx}" ${value == idx ? 'selected' : ''}>${file.name}</option>`
                                    ).join('')}
                                </select>
                            </td>
                        `;
                    } else if (colName === 'å•å…ƒæ ¼åæ ‡' || colName.toLowerCase().includes('åæ ‡') || colName.toLowerCase().includes('cell')) {
                        rowHTML += `
                            <td>
                                <input type="text" class="config-cell cell-input" 
                                       value="${value}" 
                                       data-row="${rowIndex}" 
                                       data-col="${colIndex}"
                                       placeholder="å¦‚: J5">
                            </td>
                        `;
                    } else {
                        rowHTML += `
                            <td>
                                <input type="text" class="config-cell content-input" 
                                       value="${value}" 
                                       data-row="${rowIndex}" 
                                       data-col="${colIndex}">
                            </td>
                        `;
                    }
                });
                
                rowHTML += '<td><button onclick="removeConfigRow(this)" class="btn-small danger">åˆ é™¤</button></td>';
                row.innerHTML = rowHTML;
                tbody.appendChild(row);
            });
        }

        // æ·»åŠ é…ç½®è¡Œ
        function addConfigRow(rowData = []) {
            configRows.push(rowData);
            renderConfigRows();
        }

        // åˆ é™¤é…ç½®è¡Œ
        function removeConfigRow(btn) {
            const row = btn.closest('tr');
            const rowIndex = Array.from(row.parentNode.children).indexOf(row);
            configRows.splice(rowIndex, 1);
            renderConfigRows();
        }

        // æ›´æ–°æ–‡ä»¶é€‰æ‹©ä¸‹æ‹‰æ¡†
        function updateFileSelects() {
            const selects = document.querySelectorAll('.file-select-cell select');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- é€‰æ‹©æ–‡ä»¶ --</option>';
                uploadedFiles.forEach((file, idx) => {
                    const option = document.createElement('option');
                    option.value = idx;
                    option.textContent = file.name;
                    if (currentValue == idx) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }

        // ç›‘å¬é…ç½®å˜åŒ–
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('config-cell')) {
                const rowIndex = parseInt(e.target.dataset.row);
                const colIndex = parseInt(e.target.dataset.col);
                if (configRows[rowIndex]) {
                    configRows[rowIndex][colIndex] = e.target.value;
                }
            }
        });

        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('config-cell')) {
                const rowIndex = parseInt(e.target.dataset.row);
                const colIndex = parseInt(e.target.dataset.col);
                if (configRows[rowIndex]) {
                    configRows[rowIndex][colIndex] = e.target.value;
                }
            }
        });

        // å¤„ç†æ–‡ä»¶
        async function processFiles() {
            if (uploadedFiles.length === 0) {
                showStatus('è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶', 'error');
                return;
            }

            const tbody = document.getElementById('configTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            if (rows.length === 0) {
                showStatus('è¯·è‡³å°‘æ·»åŠ ä¸€æ¡é…ç½®', 'error');
                return;
            }

            showStatus('æ­£åœ¨å¤„ç†æ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'success');

            let successCount = 0;
            let errorCount = 0;

            // è¯†åˆ«åˆ—ç´¢å¼•
            const fileColIndex = columnNames.findIndex(col => col === 'æ–‡ä»¶' || col.toLowerCase().includes('æ–‡ä»¶'));
            const cellColIndex = columnNames.findIndex(col => col === 'å•å…ƒæ ¼åæ ‡' || col.toLowerCase().includes('åæ ‡') || col.toLowerCase().includes('cell'));
            const contentColIndex = columnNames.findIndex((col, idx) => idx !== fileColIndex && idx !== cellColIndex);

            if (fileColIndex === -1 || cellColIndex === -1 || contentColIndex === -1) {
                showStatus('è¯·ç¡®ä¿æœ‰"æ–‡ä»¶"ã€"å•å…ƒæ ¼åæ ‡"å’Œå†…å®¹åˆ—', 'error');
                return;
            }

            // ä»DOMç›´æ¥è¯»å–æ‰€æœ‰é…ç½®
            const fileConfigs = {};
            rows.forEach((row, rowIndex) => {
                const cells = row.querySelectorAll('.config-cell');
                if (cells.length === 0) return;

                const fileIndex = cells[fileColIndex] ? cells[fileColIndex].value : '';
                const cellAddress = cells[cellColIndex] ? cells[cellColIndex].value.trim() : '';
                const newContent = cells[contentColIndex] ? cells[contentColIndex].value : '';

                // è·³è¿‡æ— æ•ˆé…ç½®
                if (fileIndex === '' || fileIndex === null || fileIndex === undefined) {
                    return;
                }

                if (!cellAddress) {
                    return;
                }

                if (!fileConfigs[fileIndex]) {
                    fileConfigs[fileIndex] = [];
                }

                fileConfigs[fileIndex].push({
                    cell: cellAddress.toUpperCase(),
                    content: newContent || ''
                });
            });

            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆé…ç½®
            if (Object.keys(fileConfigs).length === 0) {
                showStatus('æ²¡æœ‰æœ‰æ•ˆçš„é…ç½®ï¼Œè¯·ç¡®ä¿é€‰æ‹©äº†æ–‡ä»¶å¹¶å¡«å†™äº†å•å…ƒæ ¼åæ ‡', 'error');
                return;
            }

            console.log('é…ç½®ä¿¡æ¯:', fileConfigs);
            console.log('æ–‡ä»¶åˆ—è¡¨:', uploadedFiles.map(f => f.name));

            // å¤„ç†æ¯ä¸ªæ–‡ä»¶
            for (const [fileIndex, modifications] of Object.entries(fileConfigs)) {
                try {
                    const file = uploadedFiles[parseInt(fileIndex)];
                    if (!file) {
                        console.warn('æ–‡ä»¶ç´¢å¼•æ— æ•ˆ:', fileIndex);
                        continue;
                    }

                    console.log(`å¤„ç†æ–‡ä»¶: ${file.name}, ä¿®æ”¹é¡¹: ${modifications.length}`);

                    // è¯»å–Excelæ–‡ä»¶ï¼ˆExcelJSä¼šè‡ªåŠ¨ä¿ç•™æ‰€æœ‰æ ·å¼ï¼‰
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(arrayBuffer);

                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const worksheet = workbook.getWorksheet(1);

                    // åº”ç”¨æ‰€æœ‰ä¿®æ”¹ï¼ˆåªä¿®æ”¹valueï¼Œæ ·å¼è‡ªåŠ¨ä¿ç•™ï¼‰
                    modifications.forEach(mod => {
                        const cellAddress = mod.cell;
                        const newContent = mod.content;

                        try {
                            // ExcelJSä¼šè‡ªåŠ¨ä¿ç•™åŸæœ‰æ ·å¼ï¼Œåªéœ€ä¿®æ”¹value
                            const cell = worksheet.getCell(cellAddress);
                            cell.value = newContent; // ä»…ä¿®æ”¹å€¼ï¼Œæ ·å¼ä¸å˜
                        } catch (e) {
                            console.error('ä¿®æ”¹å•å…ƒæ ¼å¤±è´¥:', cellAddress, e);
                        }
                    });

                    console.log(`æ–‡ä»¶ ${file.name} ä¿®æ”¹å®Œæˆï¼Œå‡†å¤‡ä¸‹è½½`);

                    // ç”Ÿæˆä¿®æ”¹åçš„æ–‡ä»¶ï¼ˆExcelJSä¼šè‡ªåŠ¨ä¿ç•™æ ·å¼ï¼‰
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { 
                        type: file.name.endsWith('.xls') ? 'application/vnd.ms-excel' : 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                    });

                    // ä¸‹è½½æ–‡ä»¶
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name.replace(/\.(xlsx|xls)$/, '_ä¿®æ”¹.$1');
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    successCount++;

                    // å»¶è¿Ÿä¸‹è½½ï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢
                    await new Promise(resolve => setTimeout(resolve, 300));
                } catch (error) {
                    console.error('å¤„ç†æ–‡ä»¶å¤±è´¥:', error);
                    errorCount++;
                }
            }

            showStatus(`å¤„ç†å®Œæˆï¼æˆåŠŸ: ${successCount}, å¤±è´¥: ${errorCount}`, successCount > 0 ? 'success' : 'error');
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
